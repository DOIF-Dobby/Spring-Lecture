---


---

<hr>
<h4 id="author-김명진">author: 김명진</h4>
<h4 id="date-2021-02-17">date: 2021-02-17</h4>
<h1 id="음악-스트리밍-서비스-예제로-배우는-스프링">음악 스트리밍 서비스 예제로 배우는 스프링</h1>
<h2 id="비지니스-요구사항과-설계">1. 비지니스 요구사항과 설계</h2>
<ul>
<li>
<p><strong>회원</strong></p>
<ul>
<li>회원 가입을 하고 조회할 수 있다.</li>
<li>회원은 맴버십 등급이 있다. (NONE, NORMAL)</li>
<li>회원 데이터는 자체 DB를 구축할 수 있고, 외부 시스템과 연동할 수 있다. (미확정)</li>
</ul>
</li>
<li>
<p><strong>음악</strong></p>
<ul>
<li>음악을 등록하고 조회할 수 있다.</li>
<li>음악은 재생시간을 갖고 있다.</li>
</ul>
</li>
<li>
<p><strong>음악 스트리밍과 신규 회원 미리듣기 정책</strong></p>
<ul>
<li>회원은 음악 스트리밍을 할 수 있다.</li>
<li>회원이 맴버십이 있다면 음악의 재생시간 만큼 스트리밍을 한다.</li>
<li>회원이 맴버십이 없다면 신규 회원인지 판별하여 신규 회원 미리듣기 정책을 적용하여 스트리밍을 한다.</li>
<li>처음에는 회원들을 모집하기 위해 음악 재생시간 만큼 스트리밍을 한다.</li>
<li>맴버십에 가입한 회원들이 많아진다면 정책은 언제든지 바뀔 수 있다. (절반, 특정 시간 등등)</li>
</ul>
</li>
</ul>
<p>요구사항을 보면 <code>회원 데이터</code>, <code>신규 유저 미리듣기 정책</code> 같은 부분은 언제든지 바뀔 수 있는 부분입니다. 그렇다고 이런 부분들이 결정될 될 때 까지 개발을 무기한 연기할 수 없습니다. 이전 시간에 배운 객체 지향 설계를 적용하여 <strong>인터페이스를 먼저 만들고 구현체는 언제든지 갈아끼울 수 있도록 설계</strong>하면 됩니다.</p>
<blockquote>
<p>참고: 프로젝트 환경설정을 편리하게 하려고 스프링 부트를 사용할 것입니다. 그러나 지금은 스프링이 없는 순수한 자바로만 개발을 진행하고 후에 스프링을 사용해서 리팩토링 해 볼 것입니다.</p>
</blockquote>
<h3 id="회원-도메인-설계">1-1. 회원 도메인 설계</h3>
<p><strong>회원 도메인 요구 사항</strong><br>
- 회원 가입을 하고 조회할 수 있다.<br>
- 회원은 맴버십 등급이 있다. (NONE, NORMAL)<br>
- 회원 데이터는 자체 DB를 구축할 수 있고, 외부 시스템과 연동할 수 있다. (미확정)</p>
<ul>
<li>회원 도메인 협력 관계</li>
</ul>
<p><img src="https://github.com/DOIF-Dobby/Spring-Lecture/blob/master/images/member-domain.png?raw=true" alt="회원 도메인 협력 관계"></p>
<ul>
<li>회원 클래스 다이어그램</li>
</ul>
<p><img src="https://github.com/DOIF-Dobby/Spring-Lecture/blob/master/images/member-class-diagram.png?raw=true" alt="회원 클래스 다이어그램"></p>
<h4 id="회원-도메인-개발">회원 도메인 개발</h4>
<pre class=" language-java"><code class="prism  language-java"><span class="token comment">/**  
 * 보통 데이터베이스에서 시스템 설정으로 관리하는 값들을 임의로 설정  
 */</span>  
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppConstant</span> <span class="token punctuation">{</span>  
    <span class="token comment">// 신규유저가 아닌 유저들의 미리듣기 시간(초)  </span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> OLD_USER_PRE_LISTEN_STREAMING_TIME <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span>  
  
    <span class="token comment">// 신규 유저를 판단하는 기준 일자 (일)  </span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DECIDE_NEW_USER_DAY <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre>
<p><em>회원 맴버십 등급</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">enum</span> Membership <span class="token punctuation">{</span>  
    NONE<span class="token punctuation">,</span>  
    NORMAL<span class="token punctuation">,</span>  
<span class="token punctuation">}</span>
</code></pre>
<p><em>회원 엔티티</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token annotation punctuation">@Getter</span>  
<span class="token annotation punctuation">@Setter</span>  
<span class="token annotation punctuation">@ToString</span>  
<span class="token annotation punctuation">@AllArgsConstructor</span>  
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Member</span> <span class="token punctuation">{</span>  
    <span class="token keyword">private</span> Long id<span class="token punctuation">;</span>  
	<span class="token keyword">private</span> String name<span class="token punctuation">;</span>  
	<span class="token keyword">private</span> LocalDate joinDate<span class="token punctuation">;</span>  
	<span class="token keyword">private</span> Membership membership<span class="token punctuation">;</span>  
  
	<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isNewUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
	    <span class="token keyword">long</span> between <span class="token operator">=</span> ChronoUnit<span class="token punctuation">.</span>DAYS<span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span>joinDate<span class="token punctuation">,</span> LocalDate<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	    <span class="token keyword">return</span> between <span class="token operator">&lt;=</span> AppConstant<span class="token punctuation">.</span>DECIDE_NEW_USER_DAY<span class="token punctuation">;</span>  
   <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre>
<p><em>회원 저장소 인터페이스</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MemberRepository</span> <span class="token punctuation">{</span>  
  
	<span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span>Member member<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
	Member <span class="token function">findById</span><span class="token punctuation">(</span>Long memberId<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre>
<p><em>메모리 회원 저장소 구현체</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MemoryMemberRepository</span> <span class="token keyword">implements</span> <span class="token class-name">MemberRepository</span> <span class="token punctuation">{</span>  
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Map<span class="token operator">&lt;</span>Long<span class="token punctuation">,</span> Member<span class="token operator">&gt;</span> store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
    <span class="token annotation punctuation">@Override</span>  
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span>Member member<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
	    store<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>member<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> member<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
  
    <span class="token annotation punctuation">@Override</span>  
    <span class="token keyword">public</span> Member <span class="token function">findById</span><span class="token punctuation">(</span>Long memberId<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
	    <span class="token keyword">return</span> store<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>memberId<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre>
<p>데이터베이스가 아직 확정이 안되었습니다. 그래도 개발은 진행해야 하니 가장 단순한 메모리 회원 저장소를 구현해서 우선 개발을 진행합니다.</p>
<blockquote>
<p>참고: <code>HashMap</code> 은 동시성 이슈가 발생할 수 있습니다. 이런 경우 <code>ConcurrentHashMap</code> 을 사용합시다.</p>
</blockquote>
<p><em>회원 서비스 인터페이스</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MemberService</span> <span class="token punctuation">{</span>  
  
    <span class="token keyword">void</span> <span class="token function">join</span><span class="token punctuation">(</span>Member member<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
    Member <span class="token function">findMember</span><span class="token punctuation">(</span>Long memberId<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre>
<p><em>회원 서비스 구현체</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MemberServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">MemberService</span><span class="token punctuation">{</span>  
	<span class="token keyword">private</span> <span class="token keyword">final</span> MemberRepository memberRepository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemoryMemberRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
    <span class="token annotation punctuation">@Override</span>  
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">join</span><span class="token punctuation">(</span>Member member<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
	    memberRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>member<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
  
    <span class="token annotation punctuation">@Override</span>  
    <span class="token keyword">public</span> Member <span class="token function">findMember</span><span class="token punctuation">(</span>Long memberId<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
	    <span class="token keyword">return</span> memberRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>memberId<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre>
<h4 id="회원-도메인-실행과-테스트">회원 도메인 실행과 테스트</h4>
<p><em>메인 실행</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MemberApp</span> <span class="token punctuation">{</span>  
  
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
		MemberServiceImpl memberService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemberServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		Member memberA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Member</span><span class="token punctuation">(</span>1L<span class="token punctuation">,</span> <span class="token string">"memberA"</span><span class="token punctuation">,</span> LocalDate<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Membership<span class="token punctuation">.</span>NONE<span class="token punctuation">)</span><span class="token punctuation">;</span>  
		memberService<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>memberA<span class="token punctuation">)</span><span class="token punctuation">;</span>  

		Member findMember <span class="token operator">=</span> memberService<span class="token punctuation">.</span><span class="token function">findMember</span><span class="token punctuation">(</span>1L<span class="token punctuation">)</span><span class="token punctuation">;</span>  
		System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"findMember = "</span> <span class="token operator">+</span> findMember<span class="token punctuation">)</span><span class="token punctuation">;</span>  
		System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"findMember.isNewUser() = "</span> <span class="token operator">+</span> findMember<span class="token punctuation">.</span><span class="token function">isNewUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre>
<p>결과</p>
<pre class=" language-shell"><code class="prism  language-shell">findMember = Member(id=1, name=memberA, joinDate=2021-02-28, membership=NONE)
findMember.isNewUser() = true
</code></pre>
<p>애플리케이션 로직을 이렇게 테스트 하는 것은 좋은 방법이 아닙니다. JUnit 테스트를 사용합시다.</p>
<p><em>회원 가입 및 조회 테스트</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">class</span> <span class="token class-name">MemberServiceTest</span> <span class="token punctuation">{</span>  
	MemberService memberService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemberServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

	<span class="token annotation punctuation">@Test</span>  
	<span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"회원가입 테스트"</span><span class="token punctuation">)</span>  
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>  
		<span class="token comment">// given  </span>
		Member memberA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Member</span><span class="token punctuation">(</span>1L<span class="token punctuation">,</span> <span class="token string">"memberA"</span><span class="token punctuation">,</span> LocalDate<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Membership<span class="token punctuation">.</span>NONE<span class="token punctuation">)</span><span class="token punctuation">;</span>  

		<span class="token comment">// when  </span>
		memberService<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>memberA<span class="token punctuation">)</span><span class="token punctuation">;</span>  
		Member findMember <span class="token operator">=</span> memberService<span class="token punctuation">.</span><span class="token function">findMember</span><span class="token punctuation">(</span>1L<span class="token punctuation">)</span><span class="token punctuation">;</span>  

		<span class="token comment">// then  </span>
		<span class="token function">assertThat</span><span class="token punctuation">(</span>memberA<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span>findMember<span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token function">assertThat</span><span class="token punctuation">(</span>findMember<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token string">"memberA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token function">assertThat</span><span class="token punctuation">(</span>findMember<span class="token punctuation">.</span><span class="token function">isNewUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre>
<p>위 코드의 설계상 문제점은 <code>MemberServiceImpl</code>의 다음 코드에서 나타납니다.</p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> MemberRepository memberRepository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemoryMemberRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>의존관계가 인터페이스뿐만 아니라 구현까지 모두 의존하고 있습니다. <code>DIP</code>를 준수하지 못했고 결국 다른 저장소로 변경하게 된다면 클라이언트 코드를 수정하여 <code>OCP</code> 또한 준수하지 못합니다.</p>
<p>이 문제는 <code>음악</code>, <code>스트리밍</code> 도메인까지 만들고 해결 방안을 설명하겠습니다.</p>
<h4 id="음악-도메인-설계">음악 도메인 설계</h4>
<p><strong>음악</strong><br>
- 음악을 등록하고 조회할 수 있다.<br>
- 음악은 재생시간을 갖고 있다.</p>
<p><em>음악 엔티티</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token annotation punctuation">@Getter</span>  
<span class="token annotation punctuation">@Setter</span>  
<span class="token annotation punctuation">@ToString</span>  
<span class="token annotation punctuation">@AllArgsConstructor</span>  
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Music</span> <span class="token punctuation">{</span>  
	<span class="token keyword">private</span> Long id<span class="token punctuation">;</span>  
	<span class="token keyword">private</span> String name<span class="token punctuation">;</span>  
	<span class="token keyword">private</span> String singer<span class="token punctuation">;</span>  
	<span class="token keyword">private</span> <span class="token keyword">int</span> playTime<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre>
<p><em>음악 저장소 인터페이스</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MusicRepository</span> <span class="token punctuation">{</span>  
	
	<span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span>Music music<span class="token punctuation">)</span><span class="token punctuation">;</span>  

	Music <span class="token function">findById</span><span class="token punctuation">(</span>Long musicId<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre>
<p><em>메모리 음악 저장소 구현체</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MemoryMusicRepository</span> <span class="token keyword">implements</span> <span class="token class-name">MusicRepository</span> <span class="token punctuation">{</span>  
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Map<span class="token operator">&lt;</span>Long<span class="token punctuation">,</span> Music<span class="token operator">&gt;</span> store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

	<span class="token annotation punctuation">@Override</span>  
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span>Music music<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
		store<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>music<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> music<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  

	<span class="token annotation punctuation">@Override</span>  
	<span class="token keyword">public</span> Music <span class="token function">findById</span><span class="token punctuation">(</span>Long musicId<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
		<span class="token keyword">return</span> store<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>musicId<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre>

