---


---

<hr>
<h4 id="author-김명진">author: 김명진</h4>
<h4 id="date-2021-02-17">date: 2021-02-17</h4>
<h1 id="음악-스트리밍-서비스-예제로-배우는-스프링-1">음악 스트리밍 서비스 예제로 배우는 스프링 1</h1>
<h2 id="비지니스-요구사항과-설계">1. 비지니스 요구사항과 설계</h2>
<ul>
<li>
<p><strong>회원</strong></p>
<ul>
<li>회원 가입을 하고 조회할 수 있다.</li>
<li>회원은 맴버십 등급이 있다. (NONE, NORMAL)</li>
<li>회원 데이터는 자체 DB를 구축할 수 있고, 외부 시스템과 연동할 수 있다. (미확정)</li>
</ul>
</li>
<li>
<p><strong>음악</strong></p>
<ul>
<li>음악을 등록하고 조회할 수 있다.</li>
<li>음악은 재생시간을 갖고 있다.</li>
</ul>
</li>
<li>
<p><strong>음악 스트리밍과 신규 회원 미리 듣기 정책</strong></p>
<ul>
<li>회원은 음악 스트리밍을 할 수 있다.</li>
<li>회원이 맴버십이 있다면 음악의 재생시간 만큼 스트리밍을 한다.</li>
<li>회원이 맴버십이 없다면 신규 회원인지 판별하여 신규 회원 미리 듣기 정책을 적용하여 스트리밍을 한다.</li>
<li>처음에는 회원들을 모집하기 위해 음악 재생시간 만큼 스트리밍을 한다.</li>
<li>맴버십에 가입한 회원들이 많아진다면 정책은 언제든지 바뀔 수 있다. (절반, 특정 시간 등등)</li>
</ul>
</li>
</ul>
<p>요구사항을 보면 <code>회원 데이터</code>, <code>신규 유저 미리 듣기 정책</code> 같은 부분은 언제든지 바뀔 수 있는 부분입니다. 그렇다고 이런 부분들이 결정될 될 때 까지 개발을 무기한 연기할 수 없습니다. 이전 시간에 배운 객체 지향 설계를 적용하여 <strong>인터페이스를 먼저 만들고 구현체는 언제든지 갈아끼울 수 있도록 설계</strong>하면 됩니다.</p>
<blockquote>
<p>참고: 프로젝트 환경설정을 편리하게 하려고 스프링 부트를 사용할 것입니다. 그러나 지금은 스프링이 없는 순수한 자바로만 개발을 진행하고 후에 스프링을 사용해서 리팩토링 해 볼 것입니다.</p>
</blockquote>
<h3 id="회원-도메인-설계">1-1. 회원 도메인 설계</h3>
<p><strong>회원 도메인 요구 사항</strong><br>
- 회원 가입을 하고 조회할 수 있다.<br>
- 회원은 맴버십 등급이 있다. (NONE, NORMAL)<br>
- 회원 데이터는 자체 DB를 구축할 수 있고, 외부 시스템과 연동할 수 있다. (미확정)</p>
<ul>
<li>회원 도메인 협력 관계</li>
</ul>
<p><img src="https://github.com/DOIF-Dobby/Spring-Lecture/blob/master/images/member-domain.png?raw=true" alt="회원 도메인 협력 관계"></p>
<ul>
<li>회원 클래스 다이어그램</li>
</ul>
<p><img src="https://github.com/DOIF-Dobby/Spring-Lecture/blob/master/images/member-class-diagram.png?raw=true" alt="회원 클래스 다이어그램"></p>
<ul>
<li>회원 객체 다이어그램</li>
</ul>
<p><img src="https://github.com/DOIF-Dobby/Spring-Lecture/blob/master/images/member-object-diagram.png?raw=true" alt="회원 객체 다이어그램"></p>
<h4 id="회원-도메인-개발">회원 도메인 개발</h4>
<pre class=" language-java"><code class="prism  language-java"><span class="token comment">/**  
 * 보통 데이터베이스에서 시스템 설정으로 관리하는 값들을 임의로 설정  
 */</span>  
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppConstant</span> <span class="token punctuation">{</span>  
    <span class="token comment">// 신규유저가 아닌 유저들의 미리 듣기 시간(초)  </span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> OLD_USER_PRE_LISTEN_STREAMING_TIME <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span>  
  
    <span class="token comment">// 신규 유저를 판단하는 기준 일자 (일)  </span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DECIDE_NEW_USER_DAY <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre>
<p><em>회원 맴버십 등급</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">enum</span> Membership <span class="token punctuation">{</span>  
    NONE<span class="token punctuation">,</span>  
    NORMAL<span class="token punctuation">,</span>  
<span class="token punctuation">}</span>
</code></pre>
<p><em>회원 엔티티</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token annotation punctuation">@Getter</span>  
<span class="token annotation punctuation">@Setter</span>  
<span class="token annotation punctuation">@ToString</span>  
<span class="token annotation punctuation">@AllArgsConstructor</span>  
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Member</span> <span class="token punctuation">{</span>  
    <span class="token keyword">private</span> Long id<span class="token punctuation">;</span>  
	<span class="token keyword">private</span> String name<span class="token punctuation">;</span>  
	<span class="token keyword">private</span> LocalDate joinDate<span class="token punctuation">;</span>  
	<span class="token keyword">private</span> Membership membership<span class="token punctuation">;</span>  
  
	<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isNewUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
	    <span class="token keyword">long</span> between <span class="token operator">=</span> ChronoUnit<span class="token punctuation">.</span>DAYS<span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span>joinDate<span class="token punctuation">,</span> LocalDate<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	    <span class="token keyword">return</span> between <span class="token operator">&lt;=</span> AppConstant<span class="token punctuation">.</span>DECIDE_NEW_USER_DAY<span class="token punctuation">;</span>  
   <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre>
<p><em>회원 저장소 인터페이스</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MemberRepository</span> <span class="token punctuation">{</span>  
  
	<span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span>Member member<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
	Member <span class="token function">findById</span><span class="token punctuation">(</span>Long memberId<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre>
<p><em>메모리 회원 저장소 구현체</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MemoryMemberRepository</span> <span class="token keyword">implements</span> <span class="token class-name">MemberRepository</span> <span class="token punctuation">{</span>  
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Map<span class="token operator">&lt;</span>Long<span class="token punctuation">,</span> Member<span class="token operator">&gt;</span> store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
    <span class="token annotation punctuation">@Override</span>  
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span>Member member<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
	    store<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>member<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> member<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
  
    <span class="token annotation punctuation">@Override</span>  
    <span class="token keyword">public</span> Member <span class="token function">findById</span><span class="token punctuation">(</span>Long memberId<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
	    <span class="token keyword">return</span> store<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>memberId<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre>
<p>데이터베이스가 아직 확정이 안되었습니다. 그래도 개발은 진행해야 하니 가장 단순한 메모리 회원 저장소를 구현해서 우선 개발을 진행합니다.</p>
<blockquote>
<p>참고: <code>HashMap</code> 은 동시성 이슈가 발생할 수 있습니다. 이런 경우 <code>ConcurrentHashMap</code> 을 사용합시다.</p>
</blockquote>
<p><em>회원 서비스 인터페이스</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MemberService</span> <span class="token punctuation">{</span>  
  
    <span class="token keyword">void</span> <span class="token function">join</span><span class="token punctuation">(</span>Member member<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
    Member <span class="token function">findMember</span><span class="token punctuation">(</span>Long memberId<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre>
<p><em>회원 서비스 구현체</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MemberServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">MemberService</span><span class="token punctuation">{</span>  
	<span class="token keyword">private</span> <span class="token keyword">final</span> MemberRepository memberRepository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemoryMemberRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
    <span class="token annotation punctuation">@Override</span>  
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">join</span><span class="token punctuation">(</span>Member member<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
	    memberRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>member<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
  
    <span class="token annotation punctuation">@Override</span>  
    <span class="token keyword">public</span> Member <span class="token function">findMember</span><span class="token punctuation">(</span>Long memberId<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
	    <span class="token keyword">return</span> memberRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>memberId<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre>
<h4 id="회원-도메인-실행과-테스트">회원 도메인 실행과 테스트</h4>
<p><em>메인 실행</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MemberApp</span> <span class="token punctuation">{</span>  
  
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
		MemberServiceImpl memberService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemberServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		Member memberA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Member</span><span class="token punctuation">(</span>1L<span class="token punctuation">,</span> <span class="token string">"memberA"</span><span class="token punctuation">,</span> LocalDate<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Membership<span class="token punctuation">.</span>NONE<span class="token punctuation">)</span><span class="token punctuation">;</span>  
		memberService<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>memberA<span class="token punctuation">)</span><span class="token punctuation">;</span>  

		Member findMember <span class="token operator">=</span> memberService<span class="token punctuation">.</span><span class="token function">findMember</span><span class="token punctuation">(</span>1L<span class="token punctuation">)</span><span class="token punctuation">;</span>  
		System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"findMember = "</span> <span class="token operator">+</span> findMember<span class="token punctuation">)</span><span class="token punctuation">;</span>  
		System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"findMember.isNewUser() = "</span> <span class="token operator">+</span> findMember<span class="token punctuation">.</span><span class="token function">isNewUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre>
<p>결과</p>
<pre class=" language-shell"><code class="prism  language-shell">findMember = Member(id=1, name=memberA, joinDate=2021-02-28, membership=NONE)
findMember.isNewUser() = true
</code></pre>
<p>애플리케이션 로직을 이렇게 테스트 하는 것은 좋은 방법이 아닙니다. JUnit 테스트를 사용합시다.</p>
<p><em>회원 가입 및 조회 테스트</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">class</span> <span class="token class-name">MemberServiceTest</span> <span class="token punctuation">{</span>  
	MemberService memberService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemberServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

	<span class="token annotation punctuation">@Test</span>  
	<span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"회원가입 테스트"</span><span class="token punctuation">)</span>  
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>  
		<span class="token comment">// given  </span>
		Member memberA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Member</span><span class="token punctuation">(</span>1L<span class="token punctuation">,</span> <span class="token string">"memberA"</span><span class="token punctuation">,</span> LocalDate<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Membership<span class="token punctuation">.</span>NONE<span class="token punctuation">)</span><span class="token punctuation">;</span>  

		<span class="token comment">// when  </span>
		memberService<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>memberA<span class="token punctuation">)</span><span class="token punctuation">;</span>  
		Member findMember <span class="token operator">=</span> memberService<span class="token punctuation">.</span><span class="token function">findMember</span><span class="token punctuation">(</span>1L<span class="token punctuation">)</span><span class="token punctuation">;</span>  

		<span class="token comment">// then  </span>
		<span class="token function">assertThat</span><span class="token punctuation">(</span>memberA<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span>findMember<span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token function">assertThat</span><span class="token punctuation">(</span>findMember<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token string">"memberA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token function">assertThat</span><span class="token punctuation">(</span>findMember<span class="token punctuation">.</span><span class="token function">isNewUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre>
<p>위 코드의 설계상 문제점은 <code>MemberServiceImpl</code>의 다음 코드에서 나타납니다.</p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> MemberRepository memberRepository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemoryMemberRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>의존관계가 인터페이스뿐만 아니라 구현까지 모두 의존하고 있습니다. <code>DIP</code>를 준수하지 못했고 결국 다른 저장소로 변경하게 된다면 클라이언트 코드를 수정하여 <code>OCP</code> 또한 준수하지 못합니다.</p>
<p>이 문제는 <code>음악</code>, <code>스트리밍</code> 도메인까지 만들고 해결 방안을 설명하겠습니다.</p>
<h4 id="음악-도메인-설계">음악 도메인 설계</h4>
<p><strong>음악</strong><br>
- 음악을 등록하고 조회할 수 있다.<br>
- 음악은 재생시간을 갖고 있다.</p>
<p><em>음악 엔티티</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token annotation punctuation">@Getter</span>  
<span class="token annotation punctuation">@Setter</span>  
<span class="token annotation punctuation">@ToString</span>  
<span class="token annotation punctuation">@AllArgsConstructor</span>  
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Music</span> <span class="token punctuation">{</span>  
	<span class="token keyword">private</span> Long id<span class="token punctuation">;</span>  
	<span class="token keyword">private</span> String name<span class="token punctuation">;</span>  
	<span class="token keyword">private</span> String singer<span class="token punctuation">;</span>  
	<span class="token keyword">private</span> <span class="token keyword">int</span> playTime<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre>
<p><em>음악 저장소 인터페이스</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MusicRepository</span> <span class="token punctuation">{</span>  
	
	<span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span>Music music<span class="token punctuation">)</span><span class="token punctuation">;</span>  

	Music <span class="token function">findById</span><span class="token punctuation">(</span>Long musicId<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre>
<p><em>메모리 음악 저장소 구현체</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MemoryMusicRepository</span> <span class="token keyword">implements</span> <span class="token class-name">MusicRepository</span> <span class="token punctuation">{</span>  
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Map<span class="token operator">&lt;</span>Long<span class="token punctuation">,</span> Music<span class="token operator">&gt;</span> store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

	<span class="token annotation punctuation">@Override</span>  
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span>Music music<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
		store<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>music<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> music<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  

	<span class="token annotation punctuation">@Override</span>  
	<span class="token keyword">public</span> Music <span class="token function">findById</span><span class="token punctuation">(</span>Long musicId<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
		<span class="token keyword">return</span> store<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>musicId<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><em>음악 서비스 인터페이스</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MusicService</span> <span class="token punctuation">{</span>  
  
	<span class="token keyword">void</span> <span class="token function">addMusic</span><span class="token punctuation">(</span>Music music<span class="token punctuation">)</span><span class="token punctuation">;</span>  

	Music <span class="token function">findMusic</span><span class="token punctuation">(</span>Long musicId<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre>
<p><em>음악 서비스  구현체</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MusicServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">MusicService</span><span class="token punctuation">{</span>  
	<span class="token keyword">private</span> <span class="token keyword">final</span> MusicRepository musicRepository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemoryMusicRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

	<span class="token annotation punctuation">@Override</span>  
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addMusic</span><span class="token punctuation">(</span>Music music<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
		musicRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>music<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  

	<span class="token annotation punctuation">@Override</span>  
	<span class="token keyword">public</span> Music <span class="token function">findMusic</span><span class="token punctuation">(</span>Long musicId<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
		<span class="token keyword">return</span> musicRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>musicId<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre>
<p><em>음악 등록 및 조회 테스트</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">class</span> <span class="token class-name">MusicServiceTest</span> <span class="token punctuation">{</span>  
	MusicService musicService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MusicServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

	<span class="token annotation punctuation">@Test</span>  
	<span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"음악 추가 테스트"</span><span class="token punctuation">)</span>  
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addMusicTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>  
		<span class="token comment">// given  </span>
		Music music <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Music</span><span class="token punctuation">(</span>1L<span class="token punctuation">,</span> <span class="token string">"Tell Me"</span><span class="token punctuation">,</span> <span class="token string">"원더걸스"</span><span class="token punctuation">,</span> <span class="token number">240</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

		<span class="token comment">// when  </span>
		musicService<span class="token punctuation">.</span><span class="token function">addMusic</span><span class="token punctuation">(</span>music<span class="token punctuation">)</span><span class="token punctuation">;</span>  
		Music findMusic <span class="token operator">=</span> musicService<span class="token punctuation">.</span><span class="token function">findMusic</span><span class="token punctuation">(</span>1L<span class="token punctuation">)</span><span class="token punctuation">;</span>  

		<span class="token comment">// then  </span>
		Assertions<span class="token punctuation">.</span><span class="token function">assertThat</span><span class="token punctuation">(</span>music<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span>findMusic<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre>
<h4 id="스트리밍과-신규-회원-미리-듣기-정책-도메인-설계">스트리밍과 신규 회원 미리 듣기 정책 도메인 설계</h4>
<p><strong>음악 스트리밍과 신규 회원 미리 듣기 정책</strong><br>
- 회원은 음악 스트리밍을 할 수 있다.<br>
- 회원이 맴버십이 있다면 음악의 재생시간 만큼 스트리밍을 한다.<br>
- 회원이 맴버십이 없다면 신규 회원인지 판별하여 신규 회원 미리 듣기 정책을 적용하여 스트리밍을 한다.<br>
- 처음에는 회원들을 모집하기 위해 음악 재생시간 만큼 스트리밍을 한다.<br>
- 맴버십에 가입한 회원들이 많아진다면 정책은 언제든지 바뀔 수 있다. (절반, 특정 시간 등등)</p>
<ul>
<li>음악 스트리밍 도메인 협력, 역할, 책임</li>
</ul>
<p><img src="https://github.com/DOIF-Dobby/Spring-Lecture/blob/master/images/streaming-domain.png?raw=true" alt="음악 스트리밍 도메인 협력, 역할, 책임"></p>
<ol>
<li><strong>스트리밍 객체 생성</strong>: 클라이언트는 스트리밍 서비스에 스트리밍 생성을 요청한다.</li>
<li><strong>회원 조회</strong>: 스트리밍 시간을 구하기 위해선 회원 객체가 필요하다. 그래서 스트리밍 서비스는 회원 저장소에서 회원을 조회한다.</li>
<li><strong>음악 조회</strong>: 스트리밍 하는 음악과 스트리밍 시간을 구하기 위해선 음악 객체가 필요하다. 그래서 스트리밍 서비스는 음악 저장소에서 음악을 조회한다.</li>
<li><strong>스트리밍 시간 계산</strong>: 회원이 맴버십에 가입했는지, 신규 회원인지, 신규회원이면 어떤 정책으로 스트리밍시간을 계산할 지를 정해서 스트리밍 시간을 계산한다.</li>
<li><strong>스트리밍 객체 반환</strong>: 스트리밍 서비스는 음악과 스트리밍 시간을 포함한 스트리밍 객체를 반환한다.</li>
</ol>
<blockquote>
<p>참고: 실제로는 스트리밍 객체를 DB에 넣어서 활용할 수 있겠지만 예제가 너무 복잡해져서 단순히 스트리밍 시간을 계산해서 반환하겠습니다.</p>
</blockquote>
<ul>
<li>음악 스트리밍 도메인 전체</li>
</ul>
<p><img src="https://github.com/DOIF-Dobby/Spring-Lecture/blob/master/images/streaming-domain2.png?raw=true" alt="음악 스트리밍 도메인 전체"></p>
<p><code>역할</code>과 <code>구현</code>을 분리해서 자유롭게 구현 객체를 조립할 수 있도록 설계했습니다. 덕분에 <code>회원</code>, <code>음악</code> 저장소는 물론이고, <code>신규 회원 미리 듣기 정책</code>도 유연하게 변경할 수 있습니다.</p>
<ul>
<li>스트리밍 도메인 클래스 다이어그램</li>
</ul>
<p><img src="https://github.com/DOIF-Dobby/Spring-Lecture/blob/master/images/streaming-class-diagram.png?raw=true" alt="스트리밍 도메인 클래스 다이어그램"></p>
<ul>
<li>스트리밍 도메인 객체 다이어그램 1</li>
</ul>
<p><img src="https://github.com/DOIF-Dobby/Spring-Lecture/blob/master/images/streaming-object-diagram1.png?raw=true" alt="스트리밍 도메인 객체 다이어그램 1"></p>
<p>회원과 음악을 메모리에서 조회하고, 전체 미리 듣기 정책을 사용하다가</p>
<ul>
<li>스트리밍 도메인 객체 다이어그램 2</li>
</ul>
<p><img src="https://github.com/DOIF-Dobby/Spring-Lecture/blob/master/images/streaming-object-diagram2.png?raw=true" alt="스트리밍 도메인 객체 다이어그램 1"></p>
<p>이렇게 Jdbc 저장소와 절반 미리 듣기 정책을 사용하더라고 스트리밍 서비스를 변경하지 않아도 됩니다.<br>
협력 관계를 그대로 재사용 할 수 있습니다.</p>
<h4 id="스트리밍-도메인-개발">스트리밍 도메인 개발</h4>
<p><em>신규 회원 미리 듣기 정책 인터페이스</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">NewUserPreListenPolicy</span> <span class="token punctuation">{</span>  
	<span class="token keyword">int</span> <span class="token function">getPreListenStreamingTime</span><span class="token punctuation">(</span>Member member<span class="token punctuation">,</span> Music music<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre>
<p><em>전체 미리 듣기 정책</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FullNewUserPreListenPolicy</span> <span class="token keyword">implements</span> <span class="token class-name">NewUserPreListenPolicy</span> <span class="token punctuation">{</span>  
  
	<span class="token annotation punctuation">@Override</span>  
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPreListenStreamingTime</span><span class="token punctuation">(</span>Member member<span class="token punctuation">,</span> Music music<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
		<span class="token comment">// 신규유저 혜택  </span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>member<span class="token punctuation">.</span><span class="token function">isNewUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
			<span class="token keyword">return</span> music<span class="token punctuation">.</span><span class="token function">getPlayTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token punctuation">}</span>  

		<span class="token comment">// 맴버십이 없고 신규유저가 아니면 default 시간 스트리밍  </span>
		<span class="token keyword">return</span> AppConstant<span class="token punctuation">.</span>OLD_USER_PRE_LISTEN_STREAMING_TIME<span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre>
<p><em>스트리밍 엔티티</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token annotation punctuation">@Getter</span>  
<span class="token annotation punctuation">@Setter</span>  
<span class="token annotation punctuation">@ToString</span>  
<span class="token annotation punctuation">@AllArgsConstructor</span>  
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Streaming</span> <span class="token punctuation">{</span>  
	<span class="token keyword">private</span> Member member<span class="token punctuation">;</span>  
	<span class="token keyword">private</span> Music music<span class="token punctuation">;</span>  
	<span class="token keyword">private</span> <span class="token keyword">int</span> streamingTime<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre>
<p><em>스트리밍 서비스 인터페이스</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">StreamingService</span> <span class="token punctuation">{</span>  
	Streaming <span class="token function">createMusicStreaming</span><span class="token punctuation">(</span>Long memberId<span class="token punctuation">,</span> Long musicId<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre>
<p><em>스트리밍 서비스 구현체</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StreamingServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">StreamingService</span> <span class="token punctuation">{</span>  

	<span class="token keyword">private</span> <span class="token keyword">final</span> MemberRepository memberRepository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemoryMemberRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token keyword">private</span> <span class="token keyword">final</span> MusicRepository musicRepository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemoryMusicRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

	<span class="token keyword">private</span> <span class="token keyword">final</span> NewUserPreListenPolicy newUserPreListenPolicy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FullNewUserPreListenPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Override</span>  
	<span class="token keyword">public</span> Streaming <span class="token function">createMusicStreaming</span><span class="token punctuation">(</span>Long memberId<span class="token punctuation">,</span> Long musicId<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
		Member member <span class="token operator">=</span> memberRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>memberId<span class="token punctuation">)</span><span class="token punctuation">;</span>  
		Music music <span class="token operator">=</span> musicRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>musicId<span class="token punctuation">)</span><span class="token punctuation">;</span>  

		<span class="token comment">// 음악 스트리밍 시간을 구해야 하는데,  </span>
		<span class="token comment">// 스트리밍 요청을 한 Member가 맴버십이 "NONE"이면 "신규유저 미리듣기 정책"에서 설정한 만큼 스트리밍하고  </span>
		<span class="token comment">// 그렇지 않으면 Music의 playTime 만큼 스트리밍한다.  </span>
		<span class="token keyword">int</span> preListenStreamingTime <span class="token operator">=</span> member<span class="token punctuation">.</span><span class="token function">getMembership</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>Membership<span class="token punctuation">.</span>NONE<span class="token punctuation">)</span>  
		<span class="token operator">?</span> newUserPreListenPolicy<span class="token punctuation">.</span><span class="token function">getPreListenStreamingTime</span><span class="token punctuation">(</span>member<span class="token punctuation">,</span> music<span class="token punctuation">)</span>  
		<span class="token operator">:</span> music<span class="token punctuation">.</span><span class="token function">getPlayTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Streaming</span><span class="token punctuation">(</span>member<span class="token punctuation">,</span> music<span class="token punctuation">,</span> preListenStreamingTime<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre>
<p>현재는 스트리밍 요청이 오면 <code>메모리 회원 저장소</code>에서 회원 정보를 조회하고, <code>메모리 음악 저장소</code>에서 음악 정보를 조회한 다음 <code>전체 미리 듣기 정책</code>을 사용하여 스트리밍 객체를 반환하고 있습니다.</p>
<p><em>스트리밍 서비스 테스트</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">class</span> <span class="token class-name">StreamingServiceTest</span> <span class="token punctuation">{</span>  

	MemberService memberService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemberServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	MusicService musicService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MusicServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	StreamingService streamingService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamingServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

	<span class="token annotation punctuation">@BeforeEach</span>  
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createInitData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
		Member member <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Member</span><span class="token punctuation">(</span>1L<span class="token punctuation">,</span> <span class="token string">"신규 유저"</span><span class="token punctuation">,</span> LocalDate<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Membership<span class="token punctuation">.</span>NONE<span class="token punctuation">)</span><span class="token punctuation">;</span>  
		Music music <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Music</span><span class="token punctuation">(</span>1L<span class="token punctuation">,</span> <span class="token string">"Tell me"</span><span class="token punctuation">,</span> <span class="token string">"원더걸스"</span><span class="token punctuation">,</span> <span class="token number">240</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

		memberService<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>member<span class="token punctuation">)</span><span class="token punctuation">;</span>  
		musicService<span class="token punctuation">.</span><span class="token function">addMusic</span><span class="token punctuation">(</span>music<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  

	<span class="token annotation punctuation">@Test</span>  
	<span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"신규 유저 스트리밍 시간 테스트"</span><span class="token punctuation">)</span>  
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createStreamingTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>  
		<span class="token comment">// given  </span>

		<span class="token comment">// when  </span>
		Streaming musicStreaming <span class="token operator">=</span> streamingService<span class="token punctuation">.</span><span class="token function">createMusicStreaming</span><span class="token punctuation">(</span>1L<span class="token punctuation">,</span> 1L<span class="token punctuation">)</span><span class="token punctuation">;</span>  

		<span class="token comment">// then  </span>
		Assertions<span class="token punctuation">.</span><span class="token function">assertThat</span><span class="token punctuation">(</span>musicStreaming<span class="token punctuation">.</span><span class="token function">getStreamingTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token number">240</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre>
<h2 id="객체-지향-원리-적용">2. 객체 지향 원리 적용</h2>
<h4 id="새로운-신규-회원-미리-듣기-정책-개발">새로운 신규 회원 미리 듣기 정책 개발</h4>
<p>신규 회원 유치를 위한 <code>전체 미리 듣기</code>는 회사가 손해를 보면서 하고 있습니다. 그러다 맴버십을 가입한 회원이 많아져서 <code>전체 미리 듣기</code>를 그만 하고 신규 회원은 이제 <code>절반 미리 듣기</code>만 된다고 가정해봅시다.</p>
<p>위에서 <code>신규 회원 미리 듣기 정책</code>은 <code>인터페이스</code>와 <code>구현체</code>를 잘 분리하여 개발을 하였죠. 그래서 새로운 정책을 개발한 다음 구현체를 바꾸어 보겠습니다.</p>
<p><em>HalfNewUserPreListenPolicy 추가</em><br>
<img src="https://github.com/DOIF-Dobby/Spring-Lecture/blob/master/images/policy-01.png?raw=true" alt="스트리밍 도메인 객체 다이어그램 1"></p>
<p><em>HalfNewUserPreListenPolicy 코드</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HalfNewUserPreListenPolicy</span> <span class="token keyword">implements</span> <span class="token class-name">NewUserPreListenPolicy</span> <span class="token punctuation">{</span>  
	<span class="token annotation punctuation">@Override</span>  
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPreListenStreamingTime</span><span class="token punctuation">(</span>Member member<span class="token punctuation">,</span> Music music<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
	<span class="token comment">// 신규유저 혜택  </span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>member<span class="token punctuation">.</span><span class="token function">isNewUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
		<span class="token keyword">return</span> music<span class="token punctuation">.</span><span class="token function">getPlayTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  

	<span class="token comment">// 맴버십이 없고 신규유저가 아니면 default 시간 스트리밍  </span>
	<span class="token keyword">return</span> AppConstant<span class="token punctuation">.</span>OLD_USER_PRE_LISTEN_STREAMING_TIME<span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre>
<p><em>테스트 작성</em></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">class</span> <span class="token class-name">HalfNewUserPreListenPolicyTest</span> <span class="token punctuation">{</span>  
	NewUserPreListenPolicy newUserPreListenPolicy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HalfNewUserPreListenPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

	<span class="token annotation punctuation">@Test</span>  
	<span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"음악의 playTime 절반 만큼 스트리밍 되야한다."</span><span class="token punctuation">)</span>  
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">fullStreamingTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>  
		<span class="token comment">// given  </span>
		Member member <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Member</span><span class="token punctuation">(</span>1L<span class="token punctuation">,</span> <span class="token string">"신규 유저"</span><span class="token punctuation">,</span> LocalDate<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Membership<span class="token punctuation">.</span>NONE<span class="token punctuation">)</span><span class="token punctuation">;</span>  
		Music music <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Music</span><span class="token punctuation">(</span>1L<span class="token punctuation">,</span> <span class="token string">"Tell me"</span><span class="token punctuation">,</span> <span class="token string">"원더걸스"</span><span class="token punctuation">,</span> <span class="token number">240</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

		<span class="token comment">// when  </span>
		<span class="token keyword">int</span> preListenStreamingTime <span class="token operator">=</span> newUserPreListenPolicy<span class="token punctuation">.</span><span class="token function">getPreListenStreamingTime</span><span class="token punctuation">(</span>member<span class="token punctuation">,</span> music<span class="token punctuation">)</span><span class="token punctuation">;</span>  

		<span class="token comment">// then  </span>
		Assertions<span class="token punctuation">.</span><span class="token function">assertThat</span><span class="token punctuation">(</span>preListenStreamingTime<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre>

